RewriteEngine on

RewriteCond %{REQUEST_FILENAME} -f [OR]
RewriteCond %{REQUEST_FILENAME} -d [OR]
RewriteCond %{REQUEST_FILENAME} -s
RewriteRule ^(.*)$ $1 [L]

## common
RewriteCond %{REQUEST_URI} ^/_common/ [NC]
RewriteCond %{LA-U:REQUEST_FILENAME} !-f
RewriteRule ^(.*)$ /404.html [R=404,L]

## preview
RewriteCond %{REQUEST_URI} ^/_preview
RewriteRule ^(.*)$ $1 [L]

## mobile
RewriteCond %{HTTP_USER_AGENT} ^DoCoMo [NC,OR]
RewriteCond %{HTTP_USER_AGENT} ^KDDI [NC,OR]
RewriteCond %{HTTP_USER_AGENT} ^Up.Browser [NC,OR]
RewriteCond %{HTTP_USER_AGENT} ^J-PHONE [NC,OR]
RewriteCond %{HTTP_USER_AGENT} ^vodafone [NC,OR]
RewriteCond %{HTTP_USER_AGENT} ^SoftBank [NC]
RewriteCond %{REQUEST_URI} !^/_common/ [NC]
RewriteRule ^(.*)$ /_mobile$1 [L]

## layouts
RewriteRule ^(/_layouts)/((\d\d)(\d\d)(\d\d)(\d\d).*) $1/$3/$4/$5/$6/$7/$2 [L]

## data_files
RewriteRule ^(/_files)/((\d\d)(\d\d)(\d\d)(\d\d).*) $1/$3/$4/$5/$6/$7/$2 [L]

## ruby.1
RewriteCond %{HTTP_COOKIE} navigation_ruby=on
RewriteRule (.*)/([^\/]+)\.html$ %{REQUEST_URI}.r [L,R]

## ruby.2
RewriteCond %{HTTP_COOKIE} navigation_ruby=on
RewriteRule (.*)/$ %{REQUEST_URI}index.html.r [L,R]
